<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Telegram Login</title>
</head>
<body>
<h1>Telegram Login Test</h1>

<!-- Telegram Login Button -->
<script async src="https://telegram.org/js/telegram-widget.js?22"
        data-telegram-login="WebsocketLoginbot"
        data-size="large"
        data-request-access="write"
        data-userpic="true"
        data-onauth="onTelegramAuth(user)">
</script>

<!-- JSONni ekranga chiqarish uchun pre elementlar -->
<pre id="userInfo"></pre>
<pre id="response"></pre>

<script>
    async function onTelegramAuth(user) {
        // DTO yasash
        const userRequestDto = {
            telegramId: user.id,
            firstName: user.first_name,
            lastName: user.last_name || null,
            username: user.username || null,
            photoUrl: user.photo_url || null,
            authDate: user.auth_date,
            hash: user.hash
        };

        // Foydalanuvchi ma'lumotlarini ekranga chiqarish
        document.getElementById("userInfo").textContent =
            JSON.stringify(userRequestDto, null, 2);

        try {
            // Backendga POST so'rov yuborish
            const response = await fetch("https://93a8c02c76fb.ngrok-free.app/api/auth/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(userRequestDto)
            });

            // Response JSONini o‘qish
            const data = await response.json();

            // Natijani ekranga chiqarish
            document.getElementById("response").textContent = JSON.stringify(data, null, 2);

            // Agar token qaytsa, localStorage'ga saqlash
            if (data.token) {
                localStorage.setItem("authToken", data.token);
                alert("Login success! Token saqlandi ✅");
            } else {
                alert("Login completed, token topilmadi.");
            }

        } catch (err) {
            console.error("Error while login:", err);
            alert("Login error ❌: " + err.message);
        }
    }
</script>
</body>
</html>
